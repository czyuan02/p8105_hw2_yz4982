---
title: "p8105_hw2_yz4982"
author: "Yuanyuan Zhang"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r library}
library(tidyverse)
library(janitor)
library(lubridate) # date convert
library(readxl) 
library(scales)
```

Promblem 1
------------------------------------------------------------
### Clean Pols_Month Data
```{r}
pols_month_df = 
  read_csv("fivethirtyeight_datasets/pols-month.csv", 
           na = c("NA", ".", "")) |>
  janitor::clean_names() |>
  
  # break up the month-year-day variable
  tidyr::separate(mon, into = c("year", "month", "day"),
                  sep = "-", convert = TRUE) |>
  mutate(
    
    # replace month number with month name
    month = month.name[month],
    month = factor(month, levels = month.name, ordered = TRUE),
    
    # create a president variable, taking values gop and dem
    president = if_else(prez_gop == 1, "gop", "dem")) |>
  
  # remove prez_dem and prez_gop and the day variable
  select(-prez_gop, -prez_dem, -day)

print(pols_month_df, n = 5)
```

### Clean SNP Data
```{r} 
snp_df = 
  read_csv("fivethirtyeight_datasets/snp.csv", 
           na = c("NA", ".", "")) |>
  janitor::clean_names() |>
  
  # Convert to year-month-day
  mutate(date = mdy(date)) |>
  
  # Arrange according to year and month,
  mutate(
    year  = lubridate::year(date),
    month = lubridate::month(date),
    month = month.name[month],
    month = factor(month, levels = month.name, ordered = TRUE),
    day   = lubridate::mday(date)
  ) |>
  
  # Year and month are the leading columns
  select(year, month, close) |>
  arrange(year, month)

print(snp_df, n = 5)

```

### Clean Unemployment Data
```{r}
unemployment_df =
  read_csv("fivethirtyeight_datasets/unemployment.csv",
           na = c("NA", ".", "")) |>
  janitor::clean_names() |>                    
  
  # Wide to long 
  pivot_longer(
    cols =jan:dec,
    names_to = "month",
    values_to = "unemployment_rate"
  ) |>
  mutate(
    year  = as.integer(year),
    # Mapped the abbreviation  to the full month name and set as an ordering factor
    month = factor(
      month,
      levels = tolower(month.abb),
      labels = month.name,
      ordered = TRUE
    )
  ) |>
  select(year, month, unemployment_rate) |>
  arrange(year, month)

print(unemployment_df, n = 5)
```

### Merge SNP Into Pols
```{r}
pols_snp_df = pols_month_df |>
  left_join(snp_df, by = c("year", "month"))
print(pols_snp_df)
```

### Fianlly Merging Unemployment
```{r}
pols_snp_unemp_df = pols_snp_df |>
  left_join(unemployment_df, by = c("year", "month")) 
print(pols_snp_unemp_df, n = 5)
```

### Overview
```{r}
# dplyr view
dplyr::glimpse(pols_snp_unemp_df)

# end of 10 lines
tail(pols_snp_unemp_df, 5) 

# see missing value
colSums(is.na(pols_snp_unemp_df))

# see the table 
# View(pols_snp_unemp_df)
```
The pols-month dataset records the number of political party representatives in the U.S. by month. 
The snp dataset gives the closing price of the S&P 500 on the last trading day of each month.
The unemployment dataset contains the national unemployment rate by year and month. 

After cleaning and merging, the final dataset consists of 822 rows and 11 columns and covers the period January 1947 through June 2015. 
Key variables include political control indicators (date, the number of governors, senators, and whether the president was democratic or repubulican), S&P stock index, and unemployment_rate. The S&P data are not available prior to 1950, so close is missing in those years, and the unemployment rate is missing in a few months. 


Promblem 2
------------------------------------------------------------
### Clean Mr.Trash Wheel Sheet
```{r}
trash_path <- "./202409 Trash Wheel Collection Data.xlsx"

mr_trash_df <-
  read_excel(
    path = trash_path,
    sheet = "Mr. Trash Wheel",
    range = readxl::cell_cols("A:N"),
    na = c("NA", ".", ""),
    ) |>
  # Use reasonable variable names
  clean_names() |>
  # Convert Date type
  mutate(date = as_date(date)) |>
  # Omit rows that do not include dumpster-specific data
  filter(!is.na(dumpster), !is.na(date)) |>
  # Round the number of sports balls 
  dplyr::mutate(sports_balls = as.integer(round(sports_balls))) |>
  mutate(wheel = "Mr.Trash Wheel") |>
  relocate(wheel, .before = 1)
```


### Clean Professor Trash Wheel Sheet
```{r}
prof_trash_df <-
  read_excel(
    path  = trash_path,
    sheet = "Professor Trash Wheel",
    range = readxl::cell_cols("A:M"),
    na    = c("NA", ".", "")
  ) |>
  clean_names() |>
  mutate(date = as_date(date)) |>
  filter(!is.na(dumpster), !is.na(date)) |>
  mutate(wheel = "Professor Trash Wheel") |>
  relocate(wheel, .before = 1)
```

### Clean Gwynnda Sheet
```{r}
gwynnda_trash_df <-
  read_excel(
    path  = trash_path,
    sheet = "Gwynnda Trash Wheel",
    range = readxl::cell_cols("A:L"),
    na    = c("NA", ".", "")
  ) |>
  clean_names() |>
  mutate(date = as_date(date)) |>
  filter(!is.na(dumpster), !is.na(date)) |>
  mutate(wheel = "Gwynnda") |>
  relocate(wheel, .before = 1)
```

### Merge
```{r}
# 1)  Standardize The Date Types In Each Sheet
mr_trash_df <- mr_trash_df |>
  
  # Rebuild Consistent Types Dates
  select(-any_of(c("year", "month"))) |>
  mutate(
    date  = lubridate::as_date(date),
    year  = as.integer(lubridate::year(date)),
    month = factor(lubridate::month(date, label = TRUE, abbr = FALSE),
                   levels = month.name, ordered = TRUE)
  )

prof_trash_df <- prof_trash_df |>
  select(-any_of(c("year", "month"))) |>
  mutate(
    date  = lubridate::as_date(date),
    year  = as.integer(lubridate::year(date)),
    month = factor(lubridate::month(date, label = TRUE, abbr = FALSE),
                   levels = month.name, ordered = TRUE)
  )

gwynnda_trash_df <- gwynnda_trash_df |>
  select(-any_of(c("year", "month"))) |>
  mutate(
    date  = lubridate::as_date(date),
    year  = as.integer(lubridate::year(date)),
    month = factor(lubridate::month(date, label = TRUE, abbr = FALSE),
                   levels = month.name, ordered = TRUE)
  )


# Merge
common_vars <- Reduce(intersect, list(
  names(mr_trash_df), names(prof_trash_df), names(gwynnda_trash_df)
))

mr_trash_df <- dplyr::select(mr_trash_df,      all_of(common_vars))
prof_trash_df <- dplyr::select(prof_trash_df,    all_of(common_vars))
gwynnda_trash_df <- dplyr::select(gwynnda_trash_df, all_of(common_vars))

trash_all <- dplyr::bind_rows(
  mr_trash_df,
  prof_trash_df,
  gwynnda_trash_df
) |>
  arrange(date, wheel, dumpster)

glimpse(trash_all)
colSums(is.na(trash_all))
```

### Calculate
Total Weight Of Trash Collected By Professor Trash Wheel
```{r}
prof_total_weight <- trash_all |>
  filter(wheel == "Professor Trash Wheel") |>
  summarise(total_weight_tons = sum(weight_tons, na.rm = TRUE)) |>
  pull(total_weight_tons)
```

Total Number Of Cigarette Collected By Gwynnda In June 2022
```{r}
gwynnda_cigs_jun2022 <- trash_all |>
  filter(wheel == "Gwynnda", year(date) == 2022, month(date) == 6) |>
  summarise(total_cigarette_butts = sum(cigarette_butts, na.rm = TRUE)) |>
  pull(total_cigarette_butts)
```

### Overview
```{r}
n_obs      <- nrow(trash_all)
date_range <- range(trash_all$date, na.rm = TRUE)

prof_total_weight
gwynnda_cigs_jun2022
n_obs
date_range
```

In the cleaned and combined Trash Wheel dataset, there are `r comma(n_obs)` observations spanning `r format(date_range[1], "%b %Y")` to `r format(date_range[2], "%b %Y")`.
Each row records a dumpster collection with key variables such as `dumpster` (load ID), `date`, `weight_tons` (trash weight in tons), `volume_cubic_yards` (volume), and composition counts including `cigarette_butts`, `plastic_bottles`, and `wrappers`.

Based on available data, **Professor Trash Wheel** collected a total of `r comma(round(prof_total_weight, 2))` tons of trash, and **Gwynnda** collected `r comma(gwynnda_cigs_jun2022)` cigarette butts in **June 2022**.

Promblem 3
------------------------------------------------------------
### Clean data
```{r}
zori_path_df = 
  read_csv("zillow_data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv",
           na = c("NA", ".", ""))

zipinfo_df =
  read_csv("zillow_data/Zip Codes.csv",
           na = c("NA", ".", ""))
```

### Identify date columns and the ZIP column name in Zillow
```{r}
# Selects all column names that look like dates
date_cols <- names(zori_path_df)[grepl("^\\d{4}-\\d{2}-\\d{2}$", names(zori_path_df))]

zip_col_in_zillow <- if ("RegionName" %in% names(zori_path_df)) "RegionName" else NA
```

### Convert Zillow data to long format
```{r}
zori_long <- tidyr::pivot_longer(
  data      = zori_path_df,
  cols      = date_cols,
  names_to  = "month",
  values_to = "zori"
)

zori_long$zip   <- stringr::str_pad(as.character(zori_long[[zip_col_in_zillow]]), width = 5, pad = "0")
zori_long$month <- lubridate::ymd(zori_long$month)
```

### Filter time range 2015-01 to 2024-08
```{r}
zori_long$month <- lubridate::ymd(zori_long$month)

zori_long <- zori_long[zori_long$month >= ymd("2015-01-01") &
                       zori_long$month <= ymd("2024-08-31"), ]
```

### Merge Zillow
```{r}
# Standardize ZIP
zipinfo_df$zip <- stringr::str_pad(as.character(zipinfo_df$ZipCode), width = 5, pad = "0")

## Remove duplicate
zipinfo_clean <- unique(
  data.frame(
    zip          = zipinfo_df$zip,
    county       = trimws(as.character(zipinfo_df$County)),
    neighborhood = trimws(as.character(zipinfo_df$Neighborhood)),
    stringsAsFactors = FALSE
  )
)

# Merge Zillow long panel zori_long with the ZIP on zip.
merged_df <- merge(zori_long, zipinfo_clean, by = "zip", all.x = TRUE)
```

### Organize variables and order observations
```{r}
# County Selection
county_any <- merged_df$CountyName
county_any[is.na(county_any) | trimws(as.character(county_any)) == ""] <- merged_df$county
merged_df$county_clean <- trimws(as.character(county_any))

# Borough match
merged_df$county_clean <- gsub("\\s*County$", "", merged_df$county_clean, ignore.case = TRUE)
merged_df$county_clean <- tools::toTitleCase(tolower(merged_df$county_clean))


county_map_names  <- c("New York","Kings","Queens","Bronx","Richmond")
county_map_values <- c("Manhattan","Brooklyn","Queens","Bronx","Staten Island")
merged_df$borough <- unname(county_map_values[ match(merged_df$county_clean, county_map_names) ])

# Orders rows
meta_want <- c("RegionID","SizeRank","RegionType","StateName","State","City","Metro","CountyName")
meta_keep <- meta_want[meta_want %in% names(merged_df)]

keep_cols <- c("month","borough","county_clean","neighborhood","zip", "zori", meta_keep)
keep_cols <- keep_cols[keep_cols %in% names(merged_df)]

final_df <- merged_df[ , keep_cols, drop = FALSE]

ord <- order(final_df$month, final_df$borough, final_df$neighborhood, final_df$zip, na.last = TRUE)
final_df <- final_df[ord, , drop = FALSE]

# Output
readr::write_csv(final_df, "nyc_zori_clean.csv")
cat("Already download nyc_zori_clean.csv\n")
```

### Briefly describe
```{r}
n_obs   <- nrow(final_df)
n_zip   <- length(unique(final_df$zip))
n_neigh <- length(unique(final_df$neighborhood[!is.na(final_df$neighborhood)]))
time_lo <- min(final_df$month, na.rm = TRUE)
time_hi <- max(final_df$month, na.rm = TRUE)

cat("Total observations: ", n_obs, "\n", sep = "")
cat("Unique ZIP codes:  ", n_zip, "\n", sep = "")
cat("Unique neighborhoods (non-missing): ", n_neigh, "\n", sep = "")
cat("Time range: ", as.character(time_lo), " ~ ", as.character(time_hi), "\n", sep = "")


```
In the tidy NYC ZORI panel, each row is a ZIP–month observation from `r as.character(time_lo)` to `r as.character(time_hi)`. Key variables include
`month` (Date), `zip` (5-digit ZIP), `borough`, `county_clean`, `neighborhood`, Zillow metadata (e.g., `RegionID`, `City`, `State` when available), and the outcome `zori` (Zillow Observed Rent Index for all home types: SFR/condo/multifamily).

The final dataset contains **`r format(n_obs, big.mark=",")`** observations,
covering **`r n_zip`** distinct ZIP codes and **`r n_neigh`** distinct neighborhoods
(non-missing).


### Missing ZIPs
```{r}
zips_in_zipinfo <- unique(zipinfo_clean$zip)
zips_in_zori    <- unique(zori_long$zip)
zips_only_in_zipfile <- setdiff(zips_in_zipinfo, zips_in_zori)

cat("ZIPs in ZIP file but NOT in Zillow: ", length(zips_only_in_zipfile), "\n", sep = "")

missing_tbl <- unique(
  zipinfo_clean[zipinfo_clean$zip %in% zips_only_in_zipfile,
                c("zip","county","neighborhood")]
)

print(utils::head(missing_tbl, 20))

```
Comparing the ZIP-code crosswalk to Zillow, there are **`r length(zips_only_in_zipfile)`** ZIP codes present in the ZIP list but absent from the Zillow rental panel. These often correspond to ZIPs with little or no residential rental stock (e.g., airport facilities), PO-box or “firm” ZIPs, discontinued or newly created ZIPs, or areas with too few listings for a reliable index. 

For example, NYC ZIPs like **11371 (LaGuardia Airport)**, **11430 (JFK Airport)**, several **101xx** “firm/PO-box” ZIPs in Midtown (e.g., **10118**, Empire State Building) commonly lack standard residential rental markets and may therefore be excluded by Zillow’s methodology.

